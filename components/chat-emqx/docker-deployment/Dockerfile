# Extend vert.x image
FROM vertx/vertx3

ENV VERTICLE_HOME /usr/verticles

# service config
ENV CHAT_EMQX_HTTP_PORT 3010
ENV CHAT_EMQX_HTTP_DEBUG_LOGGING true
ENV CHAT_EMQX_HEARTBEAT_MS 30000
ENV CHAT_EMQX_MOCK_PRESENCE_REPO false
ENV CHAT_EMQX_MOCK_SESSION_STORES false

# emqx config
ENV CHAT_PUBSUB_EMQX_HOST host.docker.internal
ENV CHAT_PUBSUB_EMQX_PORT 8081
ENV CHAT_PUBSUB_EMQX_APP_ID admin
ENV CHAT_PUBSUB_EMQX_APP_SECRET public

# redis config
ENV REDIS_HOST host.docker.internal
ENV REDIS_PORT 6379

# hbase config
ENV HBASE_CLIENT_QUORUM host.docker.internal
ENV CHAT_HBASE_CLIENTPORT 2181
ENV HBASE_CLIENT_CLUSTER_DISTRIBUTED true
ENV HBASE_CLIENT_ZOOKEEPER_ZNODE_PARENT /hbase-unsecure
ENV HBASE_SESSIONS_NAMESPACE gateway_prod

EXPOSE 3010
EXPOSE 5000

# Copy files into the container
COPY application.jar $VERTICLE_HOME/

# Update working directory
WORKDIR $VERTICLE_HOME

# Launch the verticle
CMD java \
 -DCHAT_EMQX_HTTP_PORT=${CHAT_EMQX_HTTP_PORT} \
 -DCHAT_EMQX_HTTP_DEBUG_LOGGING=${CHAT_EMQX_HTTP_DEBUG_LOGGING} \
 -DCHAT_EMQX_HEARTBEAT_MS=${CHAT_EMQX_HEARTBEAT_MS} \
 -DCHAT_EMQX_MOCK_PRESENCE_REPO=${CHAT_EMQX_MOCK_PRESENCE_REPO} \
 -DCHAT_EMQX_MOCK_SESSION_STORES=${CHAT_EMQX_MOCK_SESSION_STORES} \
 -DCHAT_PUBSUB_EMQX_HOST=${CHAT_PUBSUB_EMQX_HOST} \
 -DCHAT_PUBSUB_EMQX_PORT=${CHAT_PUBSUB_EMQX_PORT} \
 -DCHAT_PUBSUB_EMQX_APP_ID=${CHAT_PUBSUB_EMQX_APP_ID} \
 -DCHAT_PUBSUB_EMQX_APP_SECRET=${CHAT_PUBSUB_EMQX_APP_SECRET} \
 -DREDIS_HOST=${REDIS_HOST} \
 -DREDIS_PORT=${REDIS_PORT} \
 -DHBASE_CLIENT_QUORUM=${HBASE_CLIENT_QUORUM} \
 -DCHAT_HBASE_CLIENTPORT=${CHAT_HBASE_CLIENTPORT} \
 -DHBASE_CLIENT_CLUSTER_DISTRIBUTED=${HBASE_CLIENT_CLUSTER_DISTRIBUTED} \
 -DHBASE_CLIENT_ZOOKEEPER_ZNODE_PARENT=${HBASE_CLIENT_ZOOKEEPER_ZNODE_PARENT} \
 -DHBASE_SESSIONS_NAMESPACE=${HBASE_SESSIONS_NAMESPACE} \
 -jar application.jar io.fizz.chat.emqx.Application